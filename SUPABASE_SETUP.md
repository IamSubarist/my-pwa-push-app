# Настройка Supabase для PWA Push Notifications

Это руководство поможет вам настроить базу данных Supabase для работы с приложением.

## Шаг 1: Создание проекта в Supabase

1. Перейдите на [supabase.com](https://supabase.com)
2. Войдите или зарегистрируйтесь
3. Создайте новый проект
4. Дождитесь завершения инициализации проекта

## Шаг 2: Получение учетных данных

1. В Dashboard проекта перейдите в **Settings** (⚙️) → **API**
2. Найдите следующие значения:
   - **Project URL** - скопируйте значение `URL`
   - **Project API keys** - скопируйте значение `service_role` key (секретный ключ!)

⚠️ **Важно**: Используйте `service_role` ключ, а не `anon` ключ, так как бэкенд должен иметь полный доступ к базе данных.

## Шаг 3: Создание таблиц

1. В Dashboard проекта перейдите в **SQL Editor** (в левом меню)
2. Нажмите **New query**
3. Скопируйте содержимое файла `backend/supabase_setup.sql`
4. Вставьте SQL код в редактор
5. Нажмите **Run** (или `Ctrl+Enter`)

Это создаст:
- Таблицу `users` для хранения пользователей
- Таблицу `push_subscriptions` для хранения подписок на уведомления
- Необходимые индексы для производительности
- Политики безопасности (Row Level Security)

## Шаг 4: Настройка переменных окружения

Добавьте следующие переменные окружения в ваш бэкенд (в `.env` файл или в настройках Render):

```env
SUPABASE_URL=https://ваш-проект.supabase.co
SUPABASE_KEY=ваш-service-role-ключ
```

### Для локальной разработки:

Создайте файл `backend/.env`:

```env
SUPABASE_URL=https://ваш-проект.supabase.co
SUPABASE_KEY=ваш-service-role-ключ
VAPID_PRIVATE_KEY=ваш-vapid-приватный-ключ
VAPID_PUBLIC_KEY=ваш-vapid-публичный-ключ
VAPID_EMAIL=mailto:your-email@example.com
SECRET_KEY=случайная-строка-для-jwt-токенов
```

### Для деплоя на Render:

1. Перейдите в ваш проект на Render
2. Откройте **Environment** в меню слева
3. Добавьте следующие переменные:
   - `SUPABASE_URL` = `https://ваш-проект.supabase.co`
   - `SUPABASE_KEY` = `ваш-service-role-ключ`
   - `VAPID_PRIVATE_KEY` = (ваш VAPID приватный ключ)
   - `VAPID_PUBLIC_KEY` = (ваш VAPID публичный ключ)
   - `VAPID_EMAIL` = `mailto:your-email@example.com`
   - `SECRET_KEY` = (случайная строка для JWT, можно сгенерировать)

## Шаг 5: Проверка настройки

После настройки вы можете проверить, что все работает:

1. **Проверка таблиц:**
   - В Supabase Dashboard перейдите в **Table Editor**
   - Вы должны увидеть две таблицы: `users` и `push_subscriptions`

2. **Проверка через API:**
   - Запустите бэкенд локально или проверьте деплой
   - Попробуйте зарегистрировать пользователя через фронтенд
   - Проверьте в Supabase, что пользователь появился в таблице `users`

## Структура таблиц

### Таблица `users`
- `id` (UUID) - уникальный идентификатор пользователя
- `username` (TEXT) - имя пользователя
- `email` (TEXT) - email пользователя (уникальный)
- `hashed_password` (TEXT) - хешированный пароль
- `created_at` (TIMESTAMPTZ) - дата создания

### Таблица `push_subscriptions`
- `id` (UUID) - уникальный идентификатор подписки
- `endpoint` (TEXT) - URL endpoint для отправки уведомлений (уникальный)
- `p256dh` (TEXT) - публичный ключ подписки
- `auth` (TEXT) - секретный ключ подписки
- `user_id` (UUID) - ссылка на пользователя (foreign key)
- `created_at` (TIMESTAMPTZ) - дата создания

## Безопасность

⚠️ **Важные замечания:**

1. **Service Role Key** - это секретный ключ с полными правами доступа. Никогда не публикуйте его в публичных репозиториях или на клиенте.

2. **Row Level Security (RLS)** - включена для обеих таблиц, но в текущей реализации бэкенд использует Service Role Key, который обходит RLS. Это нормально для серверного приложения.

3. **Пароли** - хранятся в хешированном виде с использованием bcrypt.

4. **JWT токены** - используются для аутентификации пользователей. Токены содержат `user_id` и имеют срок действия 30 дней.

## Устранение проблем

### Ошибка "relation does not exist"
- Убедитесь, что вы выполнили SQL скрипт из `backend/supabase_setup.sql`
- Проверьте, что вы используете правильный проект Supabase

### Ошибка "permission denied"
- Убедитесь, что вы используете `service_role` ключ, а не `anon` ключ
- Проверьте, что ключ скопирован полностью без лишних пробелов

### Пользователи не создаются
- Проверьте логи бэкенда
- Убедитесь, что переменные окружения установлены правильно
- Проверьте, что таблица `users` существует в Supabase

## Дополнительная информация

Для получения дополнительной информации о Supabase:
- [Документация Supabase](https://supabase.com/docs)
- [SQL Editor Guide](https://supabase.com/docs/guides/database/tables)
- [Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)

